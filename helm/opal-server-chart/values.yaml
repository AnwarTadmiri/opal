name: opal-server-v2
image:
  name: opal-server-v2

config:
  envSecrets:
    OPAL_AUTH_MASTER_TOKEN:
      name: opal-server-v2-secret
      key: OPAL_AUTH_MASTER_TOKEN
    OPAL_AUTH_PRIVATE_KEY:
      name: opal-server-v2-secret
      key: OPAL_AUTH_PRIVATE_KEY
    OPAL_AUTH_PUBLIC_KEY:
      name: opal-server-v2-secret
      key: OPAL_AUTH_PUBLIC_KEY
    OPAL_POLICY_REPO_SSH_KEY:
      name: opal-server-v2-secret
      key: OPAL_POLICY_REPO_SSH_KEY
    OPAL_POLICY_REPO_WEBHOOK_SECRET:
      name: opal-server-v2-secret
      key: OPAL_POLICY_REPO_WEBHOOK_SECRET
    OPAL_WORKER_TOKEN:
      name: opal-server-v2-secret
      key: OPAL_WORKER_TOKEN
  env:
    DD_CELERY_DISTRIBUTED_TRACING: "true"
    OPAL_POLICY_REPO_URL: "git@github.com:permitio/permit-sidecar-policy-staging.git"
    UVICORN_NUM_WORKERS: "1"
    OPAL_LOG_FORMAT_INCLUDE_PID: "true"
    OPAL_SCOPES: "1"
    OPAL_LOG_MODULE_EXCLUDE_LIST: "[]"
    OPAL_LOG_SERIALIZE: "true"
    OPAL_REPO_WATCHER_ENABLED: "0"
    OPAL_LOG_DIAGNOSE: "false"
    OPAL_LOG_COLORIZE: "false"
    OPAL_BASE_DIR: "/opal"
    OPAL_POLICY_REFRESH_INTERVAL: "60"
    OPAL_LOG_TO_FILE: "True"
    OPAL_LOG_FILE_PATH: "logs/output.log"
    OPAL_ENABLE_METRICS: "1"
    OPAL_ENABLE_DATADOG_APM: "True"
  envRef:
    DD_ENV:
      name: metadata.labels['tags.datadoghq.com/opal-server-v2.env']
    DD_SERVICE:
      name: metadata.labels['tags.datadoghq.com/opal-server-v2.service']
    DD_VERSION:
      name: metadata.labels['tags.datadoghq.com/opal-server-v2.version']
    DD_AGENT_HOST:
      name: status.hostIP

expose:
  type: external
  port: 7002
  http_paths:
    - path: /
      port: 80
      pathType: Prefix

labels_all:
  tags.datadoghq.com/opal-server-v2.service: "opal-server-v2"
  tags.datadoghq.com/opal-server-v2.version: "{{ .Values.image.tag }}"
  tags.datadoghq.com/opal-worker-v2.service: "opal-worker-v2"
  tags.datadoghq.com/opal-worker-v2.version: "{{ .Values.image.tag }}"

annotations_template: {}
